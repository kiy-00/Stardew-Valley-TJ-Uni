# 地图系统架构设计文档

## 1. 系统总体架构



## 2. 核心类职责

### 2.1 核心模块 (core/)

#### MapManager
- **主要职责**: 地图资源的全局管理
- **具体功能**:
  - 地图实例的生命周期管理
  - 地图切换控制
  - 地图缓存管理
  - 地图状态的保存与加载

#### GameMap
- **主要职责**: 单个地图实例的核心功能实现
- **具体功能**:
  - 管理地图的所有图层
  - 处理地图更新逻辑
  - 维护地图属性
  - 处理地块交互

#### MapLayer
- **主要职责**: 管理单个地图层
- **具体功能**:
  - 图层渲染
  - 图层更新
  - 图层内瓦片管理
  - 图层可见性控制

#### MapCameraManager
- **主要职责**: 视角和可视区域管理
- **具体功能**:
  - 摄像机位置更新
  - 视口范围计算
  - 边界检查
  - 跟随目标管理

#### Tile
- **主要职责**: 单个地块的数据和行为管理
- **具体功能**:
  - 地块状态维护
  - 地块属性管理
  - 地块交互处理

### 2.2 构建器模块 (builder/)

#### MapBuilder
- **主要职责**: 地图构建流程控制
- **具体功能**:
  - 提供地图创建的接口
  - 控制地图构建的步骤
  - 管理地图初始化过程

### 2.3 事件模块 (events/)

#### MapEventManager
- **主要职责**: 地图事件的处理和分发
- **具体功能**:
  - 事件注册和管理
  - 事件触发和分发
  - 观察者模式实现

### 2.4 属性模块 (properties/)

#### MapProperties
- **主要职责**: 地图全局属性管理
- **具体功能**:
  - 地图基础属性存储
  - 地图配置管理

#### TileProperties
- **主要职责**: 地块属性管理
- **具体功能**:
  - 地块基础属性存储
  - 地块行为规则定义

### 2.5 状态模块 (state/)

#### TileState
- **主要职责**: 地块状态管理
- **具体功能**:
  - 状态转换逻辑
  - 状态数据存储
  - 状态更新规则

### 2.6 工具模块 (utils/)

#### MapConstants
- **主要职责**: 系统常量定义
- **具体功能**:
  - 提供系统级常量
  - 定义枚举类型
  - 定义配置参数

#### MapUtils
- **主要职责**: 通用工具函数
- **具体功能**:
  - 坐标转换
  - 计算辅助
  - 其他通用功能

## 3. 建议添加的新类

### MapLoader
```cpp
class MapLoader {
public:
    static GameMap* loadFromTMX(const std::string& tmxFile);
    
private:
    static bool parseMapProperties(GameMap* map);
    static bool initializeLayers(GameMap* map);
    static bool loadTileProperties(GameMap* map);
    static bool setupEventHandlers(GameMap* map);
};
```

## 4. 数据流转

### 完整数据流转
```
MapManager ⟶ MapLoader: 初始化地图加载
MapLoader ⟶ MapBuilder: 构建地图实例
MapBuilder ⟶ GameMap: 创建完整地图对象
GameMap ⟶ MapLayer: 图层管理和更新
MapLayer ⟶ Tile: 地块操作和状态
MapEventManager ⟺ 所有模块: 事件通知
```

### 建议的文件结构
```
map/
├── loader/              // 新建文件夹
│   ├── MapLoader.h
│   └── MapLoader.cpp
├── builder/            // 已存在
│   ├── MapBuilder.h
│   └── MapBuilder.cpp
├── core/              // 核心类
│   ├── GameMap.h/cpp
│   ├── MapLayer.h/cpp
│   ├── Tile.h/cpp
│   ├── MapManager.h/cpp
│   └── MapCameraManager.h/cpp
├── events/
│   └── MapEventManager.h/cpp
├── properties/
│   ├── MapProperties.h/cpp
│   └── TileProperties.h/cpp
├── state/
│   └── TileState.h/cpp
└── utils/
    ├── MapConstants.h
    └── MapUtils.h/cpp
```

### 职责说明：
1. **MapManager**
   - 管理地图生命周期
   - 调用 MapLoader 加载地图
   - 维护地图缓存

2. **MapLoader** (loader/)
   - 解析 TMX 文件
   - 调用 MapBuilder 构建地图
   - 处理加载错误

3. **MapBuilder** (builder/)
   - 分步构建 GameMap 实例
   - 设置地图属性
   - 初始化各个系统

4. **GameMap**
   - 持有并管理所有图层
   - 处理地图更新逻辑
   - 响应地图事件

### MapLoader 和 MapBuilder 的区别：
- **MapLoader**: 负责资源加载、解析
- **MapBuilder**: 负责对象构建、组装

这样的流程更加清晰且符合单一职责原则。你觉得这个结构合理吗？需要我详细解释某个部分吗？
